# B站操作快速参考

## 常用操作速查表

### 页面导航

| 操作 | MCP 工具调用 | 说明 |
|------|-------------|------|
| 打开页面 | `new_page({url: "https://www.bilibili.com"})` | 打开指定 URL |
| 列出页面 | `list_pages()` | 查看所有打开的页面 |
| 选择页面 | `select_page({pageId: 5})` | 选择要操作的页面 |
| 检查 URL | `evaluate_script({function: "() => window.location.href"})` | 检查当前页面 URL |

### 元素查找

| 操作 | 方法 | 说明 |
|------|------|------|
| 获取快照 | `take_snapshot({verbose: true})` | 获取页面元素快照 |
| 搜索文本 | `grep({pattern: "点赞", path: "snapshot.txt"})` | 在快照中搜索文本 |
| 查找点赞按钮 | 搜索 `"点赞（Q）"` | 通过描述属性查找 |
| 查找收藏按钮 | 搜索 `"收藏（E）"` | 通过描述属性查找 |

### 交互操作

| 操作 | MCP 工具调用 | 验证方法 |
|------|-------------|---------|
| 点击元素 | `click({uid: "6_457"})` | 检查元素状态变化 |
| 点赞视频 | 点击点赞按钮 | 检查点赞数是否增加 |
| 收藏视频 | 点击收藏按钮 → 选择文件夹 → 确定 | 检查对话框是否关闭 |

## 标准操作流程

### 1. 页面跳转验证流程

```
点击链接
  ↓
sleep(2-3)
  ↓
list_pages() → 检查新页面
  ↓
如果有新页面 → select_page(新页面)
  ↓
如果没有新页面 → evaluate_script(检查URL)
  ↓
如果 URL 已变化 → 继续操作
  ↓
如果 URL 未变化 → sleep(2) → 再次检查
  ↓
如果仍未变化 → new_page(最后手段)
```

### 2. 点赞操作流程

```
take_snapshot({verbose: true})
  ↓
grep("点赞（Q）") → 找到 uid
  ↓
记录当前点赞数
  ↓
click({uid: "点赞按钮uid"})
  ↓
sleep(1.5)
  ↓
take_snapshot() → 验证点赞数增加
```

### 3. 收藏操作流程

```
take_snapshot({verbose: true})
  ↓
grep("收藏（E）") → 找到 uid
  ↓
click({uid: "收藏按钮uid"})
  ↓
sleep(2) → 等待对话框打开
  ↓
take_snapshot({verbose: true})
  ↓
grep("学习") → 找到文件夹
  ↓
click({uid: "文件夹listitem或LabelText"})
  ↓
sleep(1) → 等待选择
  ↓
grep("确定") → 检查按钮状态
  ↓
click({uid: "确定按钮uid"})
  ↓
sleep(2) → 等待操作完成
  ↓
take_snapshot() → 验证对话框关闭
```

## 常见元素定位

### 点赞按钮
- **描述**：`"点赞（Q）"`
- **类型**：`generic`
- **查找方法**：搜索描述文本或点赞数（如"1.4万"）

### 收藏按钮
- **描述**：`"收藏（E）"`
- **类型**：`generic`
- **查找方法**：搜索描述文本或收藏数（如"2.8万"）

### 收藏对话框
- **标题**：`"添加到收藏夹"`
- **文件夹**：`listitem level="1"` 包含 `LabelText` 和 `StaticText`
- **确定按钮**：`button "确定"`，注意 `disabled` 状态

### 历史记录
- **链接**：导航栏中的 `link "历史"`
- **视频列表**：每个视频是一个 `link`，包含标题和时间

## 等待时间参考

| 操作类型 | 建议等待时间 | 说明 |
|---------|------------|------|
| 页面跳转 | 2-3 秒 | 让页面有时间加载 |
| 对话框打开 | 2 秒 | 等待对话框完全显示 |
| 操作响应 | 1-1.5 秒 | 等待服务器响应 |
| 页面加载 | 3 秒 | 确保页面完全加载 |

## 错误处理

### 元素不存在
1. 重新获取快照
2. 使用 verbose 模式
3. 检查页面是否完全加载

### 操作失败
1. 检查是否需要登录
2. 检查元素是否可点击（disabled 状态）
3. 增加等待时间后重试

### 页面未跳转
1. 先等待 2-3 秒
2. 检查是否有新页面
3. 检查当前页面 URL
4. 最后才使用 new_page

## 性能优化

1. **快照使用**：
   - 普通快照：简单查找
   - Verbose 模式：复杂结构（较慢）

2. **元素查找**：
   - 优先使用文本搜索
   - 使用 grep 在快照文件中搜索
   - 避免依赖固定 uid

3. **批量操作**：
   - 独立操作可以并行
   - 相互依赖的操作必须顺序执行
