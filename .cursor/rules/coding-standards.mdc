---
description: MCP 工具使用规范
alwaysApply: true
---

# MCP 工具使用规范

## 基本原则

1. **先检查后使用**：在使用任何 MCP 工具前，必须先查看工具的 schema/描述文件，了解：

   - 工具的名称和功能
   - 必需参数和可选参数
   - 参数类型和格式要求
   - 返回值格式

2. **工具调用流程**：
   ```
   理解任务 → 选择工具 → 检查工具描述 → 准备参数 → 调用工具 → 验证结果
   ```

## 浏览器自动化（Chrome DevTools MCP）

### 核心工作流

Chrome DevTools MCP 使用基于快照（snapshot）的元素选择机制：

1. **打开页面**：使用 `new_page` 工具打开 URL
2. **选择页面**：使用 `select_page` 选择要操作的页面（如果有多个页面）
3. **获取快照**：使用 `take_snapshot` 获取页面可访问性树，每个元素都有唯一的 `uid`
4. **操作元素**：使用元素的 `uid` 进行操作（点击、填写等）

### 常用操作

- **打开新页面**：`new_page`（参数：url, background, timeout）
- **列出所有页面**：`list_pages`（无参数）
- **选择页面**：`select_page`（参数：pageId, bringToFront）
- **关闭页面**：`close_page`（参数：pageId）- 用于故障恢复，关闭有问题的页面
- **获取页面快照**：`take_snapshot`（参数：verbose, filePath）- **关键步骤**，用于获取元素 uid
- **点击元素**：`click`（参数：uid, dblClick, includeSnapshot）
- **填写表单**：`fill_form`（参数：elements[{uid, value}], includeSnapshot）
- **按键操作**：`press_key`（参数：key, includeSnapshot）- 用于快捷键、导航键等
- **截图**：`take_screenshot`（参数：format, quality, uid, fullPage, filePath）
- **执行 JavaScript**：`evaluate_script`（参数：function, args）- 返回 JSON 可序列化的值
- **查看网络请求**：`list_network_requests`、`get_network_request`
- **查看控制台**：`list_console_messages`、`get_console_message`

### 最佳实践

1. **快照优先**：

   - 操作元素前必须先调用 `take_snapshot` 获取最新的页面状态
   - 快照提供元素的 `uid`，这是操作元素的唯一标识
   - 优先使用快照而非截图来了解页面结构

2. **页面管理**：

   - 打开页面后，使用 `list_pages` 查看所有打开的页面
   - 使用 `select_page` 选择要操作的页面
   - 多个页面时，确保选择正确的页面上下文

3. **元素操作**：

   - 从快照中找到目标元素的 `uid`
   - 使用 `uid` 进行点击、填写等操作
   - 操作后如需查看结果，可设置 `includeSnapshot: true` 或再次调用 `take_snapshot`
   - **交互操作验证**：对于点赞、收藏等交互操作，必须验证操作是否成功（见下方详细规则）

4. **错误处理**：

   - 如果元素不存在，重新获取快照（页面可能已更新）
   - 页面加载可能需要时间，适当等待后再操作
   - 使用 `evaluate_script` 可以检查页面状态（如元素是否存在）

5. **性能优化**：

   - 只在必要时获取快照（`take_snapshot` 可能较慢）
   - 使用 `includeSnapshot: false` 避免不必要的快照
   - 批量操作时，使用 `fill_form` 一次性填写多个字段

6. **登录检测**：
   - 获取快照后，检查页面是否包含登录表单或登录提示
   - 如果检测到登录场景，立即停止并告知用户
   - 不要尝试自动填写或提交登录信息

## 错误处理

- **工具调用失败**：检查参数是否正确，工具是否可用
- **页面操作失败**：检查元素是否存在，页面是否加载完成
- **超时**：适当增加等待时间或重试
- **权限问题**：确认是否有执行该操作的权限

## 故障恢复（重要）

**遇到严重问题时，允许关闭浏览器实例并重启 Cursor**：

### 何时需要故障恢复

以下情况可以考虑故障恢复：

1. **浏览器无响应**：

   - 页面长时间无法加载
   - 工具调用超时或失败
   - 无法获取页面快照

2. **页面状态异常**：

   - 页面卡死或崩溃
   - 元素无法找到或操作失败
   - 页面出现严重错误

3. **工具连接问题**：
   - MCP 工具无法正常调用
   - 浏览器实例连接断开

### 故障恢复流程

1. **页面问题**：`list_pages` → `close_page` 关闭异常页面 → 重新打开重试
2. **严重问题**：告知用户重启 Cursor（用户手动操作确认后再继续）
3. **需要用户帮助**：立即暂停并说明需要用户处理的事项（如验证码/授权/确认）

暂停通知模板：`遇到问题需要您的帮助：<问题>。已暂停执行，请指示如何处理。`

## 安全注意事项

- 不执行可能造成数据丢失的操作（除非明确要求）
- 不访问或泄露敏感信息
- 截图时注意隐藏敏感内容（密码、个人信息等）
- 不执行可能影响系统稳定性的操作

## 登录场景处理（重要）

**遇到登录场景时必须立即停止**：

1. **检测登录场景**：在执行浏览器操作时，如果发现以下情况，视为需要登录：

   - 页面出现登录表单（用户名/密码输入框）
   - 页面要求输入验证码
   - 页面显示"请登录"、"Sign in"等提示
   - URL 包含 login、signin、auth 等关键词
   - 页面重定向到登录页面

2. **立即停止流程**：

   - 一旦检测到登录场景，**立即停止所有操作**
   - 明确告知用户："检测到需要登录的场景，已停止执行。请提供登录凭据或指示如何处理。"
   - 可以提供截图帮助用户了解当前页面状态
   - **不要尝试**：
     - 自动填写登录表单
     - 猜测或使用任何凭据
     - 继续执行后续操作
     - 绕过登录机制

3. **等待用户指示**：
   - 等待用户明确指示后再继续
   - 如果用户提供凭据，可以协助填写（但需明确告知风险）
   - 如果用户要求跳过或使用其他方式，按用户指示执行

## 交互操作验证（重要）

**对于点赞、收藏、关注等交互操作，必须验证操作是否成功**：

### 验证流程

1. **操作前记录状态**：

   - 执行操作前，通过 `take_snapshot` 记录目标元素的状态
   - 注意元素的视觉特征（颜色、图标、文本等）
   - 例如：点赞按钮是灰色（未点赞）还是红色（已点赞）

2. **执行操作**：

   - 调用 `click` 或其他操作工具执行交互

3. **等待并验证**：

   - **必须等待至少 1 秒**，让页面有时间响应操作
   - 等待后，重新调用 `take_snapshot` 获取最新页面状态
   - 对比操作前后的元素状态变化：
     - 按钮颜色变化（如从黑白变成彩色）
     - 图标变化（如从空心变成实心）
     - 文本变化（如"收藏"变成"已收藏"）
     - 元素属性变化（如 `aria-pressed` 从 `false` 变成 `true`）

4. **判断操作结果**：
   - 如果检测到预期的状态变化 → 操作成功
   - 如果状态未变化或出现错误提示 → 操作失败

### 失败处理策略

根据操作之间的依赖关系，采用不同的处理策略：

#### 1. 相互依赖的操作链（必须立即停止）

**场景**：操作之间存在依赖关系，后续操作依赖前一步的成功

- 例如：先登录 → 再点赞 → 再评论（评论依赖点赞成功）

**处理方式**：

- 一旦检测到操作失败，**立即停止所有后续操作**
- 明确告知用户："操作失败：[具体操作]，已停止执行。失败原因：[如需要登录、网络错误等]"
- 提供当前页面状态（截图或快照）

#### 2. 独立操作（继续完成剩余操作）

**场景**：操作之间相互独立，互不影响

- 例如：点赞和收藏（可以独立完成，互不影响）

**处理方式**：

- 记录失败的操作，但**继续执行剩余的所有操作**
- 完成所有操作后，统一告知用户：
  - 成功操作列表
  - 失败操作列表及失败原因
  - 例如："已完成：点赞成功、收藏成功、关注失败（需要登录）"

### 验证示例

独立操作（如点赞和收藏）：
- 操作失败时继续执行剩余操作
- 完成后统一报告所有操作结果

## 示例工作流

### 典型流程

1. 检查工具描述 → 打开页面 → 选择页面 → 获取快照
2. 找到元素 uid → 执行操作 → 等待响应 → 验证结果

### 关键要点

- **快照是核心**：所有元素操作都依赖 `take_snapshot` 获取的 `uid`
- **页面上下文**：确保已选择正确的页面（`select_page`）
- **快照更新**：页面变化后需要重新获取快照才能找到新元素
- **批量操作**：`fill_form` 可以一次性填写多个字段，比多次调用更高效

## Blender 3D 建模（Blender MCP）

Blender MCP 用于 3D 模型生成、导入、导出和场景操作。详细操作指南请参考 `operations/blender-operations.mdc`。

### 关键要点

- **状态检查必须完整**：使用 `poll_rodin_job_status` 检查生成任务状态，所有状态必须为 "Done" 才能导入
- **避免模型重叠**：导入后立即使用 `execute_blender_code` 调整位置
- **GLTF 导出格式**：使用 `bpy.ops.export_scene.gltf`，设置 `export_format='GLTF_SEPARATE'` 和 `export_materials='EXPORT'`
- **模型优化**：添加细分修改器（视口级别 2-4，渲染级别 3-5），应用平滑着色
- **视口模式**：切换到 MATERIAL 或 RENDERED 模式才能看到材质效果

## 操作文档与命令

- **操作文档**：`.cursor/rules/operations/*.mdc`（`alwaysApply: false`，按需查阅）
- **一句话命令**：`docs/COMMANDS.md`（你直接说“总结/导出成果/精简文档”等即可）

## 操作总结规范

当用户要求"总结"操作时，需要：

1. **记录操作**：操作时间、完成的任务、遇到的问题和解决方案
2. **提取经验**：操作流程优化、性能优化建议、关键经验总结
3. **更新文档**：将总结内容整合到对应的操作文档中

### 总结后的行动

完成总结后，需要：

1. **更新操作文档**：将问题和解决方案添加到 `operations/[操作名称]-operations.mdc` 的"常见问题及解决方案"部分
2. **更新全局文档**：在 `coding-standards.mdc` 的对应章节中添加简要总结
3. **文档组织**：总结内容整合到操作文档中，不创建单独的总结文件
4. **导出成果**：如果用户要求导出成果，参考 `results/[操作名称]-operations/` 文件夹结构，将项目文件、模型、材质、文档等导出到对应的子文件夹中

### 导出成果规范

当用户要求"导出成果"时，需要：

1. **参考现有结构**：查看 `results/` 文件夹下已有的操作文件夹（如 `bilibili-operations/`），使用相同的文件夹结构
2. **创建子文件夹**：在 `results/` 下创建 `[操作名称]-operations/` 子文件夹
3. **可回滚备份（必须）**：若目标子文件夹已存在成果，先创建 `old/` 子文件夹并将原成果全部移动进去（例如 `results/blender-operations/old/`）
3. **导出项目文件**：
   - 项目源文件（如 `.blend`、`.js`、`.py` 等）
   - 生成的模型/资源文件（如 `.gltf`、`.bin`、`.png` 等）
   - 配置文件和数据文件（如 `.json`、`.md` 等）
4. **创建文档**：
   - `README.md`：项目说明文档，包含使用说明和文件说明
   - `SUMMARY.md`：操作总结文档，参考现有格式（操作时间、完成的任务、遇到的问题和解决方案、操作流程优化、关键经验总结）
5. **文件组织**：将所有相关文件移动到子文件夹中，保持 `results/` 根目录整洁

### 导出过程的人工检查与回滚

- **如果导出过程中遇到问题需要用户检查**：必须暂停，并告知用户可选项：
  - **取消导出**：将 `old/` 中的文件恢复到原位置，视作本次导出未发生
  - **继续导出**：用户处理完问题后，继续导出流程
- **导出成功后的确认（必须）**：
  - 导出完成后先保留 `old/`，等待用户回复 **`确认`** 才删除 `old/`
  - 用户回复 **`取消导出`**：立即执行回滚（恢复 `old/`）

### 导出成果示例

参考 `results/bilibili-operations/` 和 `results/blender-operations/` 的结构：
- 使用子文件夹组织内容
- 包含 README.md 和 SUMMARY.md
- 项目文件、资源文件、文档文件分类清晰

### 总结流程

当用户说"总结"时：
1. 回顾本次对话中完成的所有操作
2. 识别遇到的问题和解决方案
3. 提取可复用的操作流程
4. 更新或创建对应的操作文档
5. 如果用户要求导出成果，按照导出成果规范执行
6. 向用户报告总结完成情况

### 注意事项

- **不要创建单独的总结文件**：总结内容应该整合到操作文档中
- **保持文档更新**：总结后必须更新相关文档
- **提取可复用经验**：重点关注可以复用的操作流程和问题解决方案
- **结构化记录**：使用清晰的结构记录，方便后续查阅
