---
description: B站操作最佳实践和常见问题解决方案
alwaysApply: false
---

# B站操作最佳实践

## 📚 参考代码资源

**在执行 B站操作之前，强烈建议先参考以下代码资源**：

- **代码库位置**：`results/bilibili-operations/`
- **主要文件**：
  - `bilibili-helpers.js` - 基础辅助函数（元素查找、操作验证等）
  - `bilibili-page-navigation.js` - 页面跳转验证函数（避免重复打开页面）
  - `bilibili-operations-template.js` - 完整操作模板（点赞、收藏等一键执行）
  - `snapshot-parser.py` - 快照文件解析工具
- **文档**：
  - `README.md` - 完整使用说明和集成指南
  - `usage-examples.md` - 详细使用示例
  - `quick-reference.md` - 快速参考手册

**使用方式**：
- 这些函数可以通过 `evaluate_script` 工具调用
- 参考 `README.md` 了解如何集成和使用这些函数
- 优先使用现成的函数和模板，避免重复编写代码

## 操作流程（最短可复用）

### 典型操作：打开视频、点赞、收藏

1. **打开页面**：使用 `new_page` 打开 bilibili
2. **导航到目标页面**：通过点击链接或直接打开 URL
3. **跳转验证**：点击链接后先 `sleep(2-3)`，再 `list_pages` / `evaluate_script`；`new_page` 仅最后手段
4. **获取快照**：`take_snapshot`（复杂结构用 `verbose: true`）
5. **执行操作**：点击/填写等
6. **验证结果**：等待 1-2 秒后再次快照对比状态变化

## 常见问题及解决方案

### 1. MCP 服务器连接问题

**问题**：工具调用失败，提示浏览器实例已运行但无法连接

**解决方案**：
- 重启 Cursor 让 MCP 服务器重新初始化
- 如果问题持续，检查 MCP 服务器配置

### 2. 页面元素查找困难

**问题**：无法快速找到目标元素（如点赞、收藏按钮）

**解决方案**：
- **优先使用 verbose 模式**：`take_snapshot({verbose: true})` 获取更详细的元素信息
- **使用 grep 搜索**：在快照文件中搜索关键词（如"点赞"、"收藏"、"学习"）
- **查找描述文本**：B站按钮通常有 `description` 属性，如 `"点赞（Q）"`、`"收藏（E）"`
- **查找数字标识**：点赞数、收藏数等数字文本可以帮助定位元素

### 3. 元素 UID 变化

**问题**：页面更新后元素的 `uid` 会变化

**解决方案**：
- **不要缓存 uid**：每次操作前重新获取快照
- **使用描述性搜索**：通过文本内容或描述属性查找，而不是依赖固定的 uid
- **操作后立即验证**：使用 `includeSnapshot: true` 或重新获取快照

### 4. 页面加载时间

**问题**：页面加载需要时间，操作太快会失败

**解决方案**：
- **关键操作后等待**：点击链接、打开对话框后等待 1-2 秒
- **使用 `sleep` 命令**：`sleep 2` 确保页面完全加载
- **验证元素存在**：操作前检查元素是否在快照中

### 5. 收藏对话框操作

**问题**：收藏对话框的元素结构复杂，难以定位

**解决方案**：
- **使用 verbose 模式**：获取完整的元素树结构
- **查找列表项**：收藏夹通常以 `listitem` 形式存在
- **点击 LabelText**：点击文件夹名称的 `LabelText` 元素来选择
- **检查按钮状态**：确定按钮从 `disabled` 变为可用状态表示选择成功

### 6. 重复打开页面问题

**问题**：点击链接后，又使用 `new_page` 打开了相同的页面，导致重复打开

**原因分析**：
- 点击链接后，页面可能在新标签页打开，或需要时间跳转
- 没有先检查是否有新页面打开（`list_pages`）
- 没有等待足够时间让页面跳转
- 直接使用 `new_page` 作为"备用方案"，但实际上页面可能已经在加载

**解决方案**：
1. click → `sleep(2-3)`（必须）
2. `list_pages`：优先检查是否开了新页面
3. 无新页：`evaluate_script(() => window.location.href)` 检查当前 URL
4. 仍未跳转：再等 1-2 秒；`new_page` 仅最后手段

**避免的错误**：
- ❌ 点击链接后立即检查 URL，发现还在原页面就使用 `new_page`
- ❌ 不检查是否有新页面打开
- ❌ 不等待足够时间让页面跳转

### 7. 操作验证

**问题**：如何确认操作是否成功

**解决方案**：
- **点赞验证**：检查点赞数是否增加（如从"1.4万"变为"1.5万"）
- **收藏验证**：检查收藏对话框是否关闭，或收藏数是否增加
- **等待后验证**：操作后等待 1-2 秒再验证，给页面响应时间

## B站特定元素定位技巧

### 点赞按钮
- 查找包含 `"点赞（Q）"` 描述的 `generic` 元素
- 或查找包含点赞数的 `StaticText`（如"1.4万"）的父元素

### 收藏按钮
- 查找包含 `"收藏（E）"` 描述的 `generic` 元素
- 或查找包含收藏数的 `StaticText`（如"2.8万"）的父元素

### 收藏夹选择
- 收藏对话框标题：`"添加到收藏夹"`
- 收藏夹列表项：`listitem level="1"`
- 文件夹名称：`StaticText` 包含文件夹名（如"学习"）
- 确定按钮：`button "确定"`，注意检查是否 `disabled`

### 历史记录
- 历史记录链接：导航栏中的 `link "历史"`
- 历史记录视频：查找视频标题中包含关键词的 `link` 元素

## 页面跳转验证标准流程

### 点击链接后的标准流程

**必须遵循以下步骤，避免重复打开页面**：

```
1. click(链接元素) - 点击链接
2. sleep(2-3) - 等待页面跳转（必须！）
3. list_pages() - 检查是否有新页面打开
4. 如果有新页面：
   - select_page(新页面) - 选择新页面
   - evaluate_script(() => window.location.href) - 验证 URL
   - 如果 URL 正确：继续操作 ✅
   - 如果 URL 不正确：等待 1 秒后重试
5. 如果没有新页面：
   - evaluate_script(() => window.location.href) - 检查当前页面 URL
   - 如果 URL 已变化为目标 URL：继续操作 ✅
   - 如果 URL 未变化：
     - sleep(2) - 再等待 2 秒
     - evaluate_script(() => window.location.href) - 再次检查
     - 如果仍未变化：使用 new_page(目标URL) - 最后手段 ✅
```

### 关键原则

1. **先等待，再检查**：点击链接后必须等待 2-3 秒
2. **先检查新页面，再检查当前页面**：优先使用 `list_pages` 检查是否有新页面
3. **new_page 是最后手段**：只有在确认页面确实没有跳转时，才使用 `new_page`
4. **不要立即使用备用方案**：发现 URL 未变化时，先等待并重试，不要立即使用 `new_page`

## 优化建议

### 1. 批量操作优化
- 对于多个独立操作（如点赞和收藏），可以并行执行
- 但要注意操作之间的依赖关系

### 2. 快照使用优化
- 只在必要时使用 verbose 模式（较慢）
- 普通快照用于查找元素，verbose 用于复杂结构

### 3. 错误处理
- 如果元素不存在，重新获取快照
- 如果操作失败，检查是否需要登录
- 如果页面未加载完成，增加等待时间

### 4. 页面跳转处理
- 点击链接后必须遵循标准验证流程
- 避免在没有验证的情况下使用 `new_page`
- 优先检查新页面，再检查当前页面 URL

## 示例工作流

### 典型流程：点赞并收藏视频

1. 打开页面 → 导航到目标视频
2. 点击链接后：sleep(2-3) → list_pages() → 检查新页面或当前 URL
3. 获取快照（verbose 模式用于复杂结构）
4. 执行操作 → sleep(1-2) → 验证结果
5. 操作后重新获取快照验证状态变化

## 注意事项

1. **登录检测**：如果遇到登录提示，立即停止并告知用户
2. **操作验证**：每次交互操作后必须验证是否成功
3. **等待时间**：关键操作后必须等待足够时间让页面响应
4. **元素查找**：优先使用描述性搜索而非固定 uid
5. **错误恢复**：如果操作失败，重新获取快照并重试
6. **避免重复打开页面**：点击链接后必须先等待并检查页面状态，不要立即使用 `new_page` 作为备用方案
7. **页面跳转检查**：点击链接后使用 `list_pages` 和 `evaluate_script` 检查页面状态，确认是否需要使用 `new_page`
